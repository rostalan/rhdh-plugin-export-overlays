name: Run Plugin Smoke Tests

on:
  workflow_call:
    inputs:
      target-branch:
        description: PR target branch (main or release-X.Y)
        type: string
        default: main
    outputs:
      success:
        description: Overall smoke test result
        value: ${{ jobs.run.outputs.success }}
      failed-plugins:
        description: Newline-separated list of plugins that failed to load
        value: ${{ jobs.run.outputs.failed-plugins }}
      error-logs:
        description: Extracted error messages from container logs
        value: ${{ jobs.run.outputs.error-logs }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
      packages: read
    outputs:
      success: ${{ steps.collect-results.outputs.success }}
      failed-plugins: ${{ steps.collect-results.outputs.failed-plugins }}
      error-logs: ${{ steps.capture-errors.outputs.error-logs }}
    steps:
      - name: Download smoke test artifacts
        uses: actions/download-artifact@v4
        with:
          name: smoke-test-artifacts
          path: ./artifacts

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start RHDH with test plugins config
        run: |
          set -euo pipefail
          ls -la ./artifacts/ || true
          
          if [ ! -f "./artifacts/dynamic-plugins.test.yaml" ]; then
            echo "Error: dynamic-plugins.test.yaml not found in artifacts"
            exit 1
          fi

          echo "dynamic-plugins.test.yaml contents:"
          sed -n '1,40p' ./artifacts/dynamic-plugins.test.yaml || true
          
          # Build Docker run command with conditional volume mounts
          ENV_ARGS=$( [ -f ./artifacts/test.env ] && echo "--env-file ./artifacts/test.env" || echo "" )
          DOCKER_CMD="docker run -d --name rhdh -p 7007:7007 $ENV_ARGS"
          if [ -f "./artifacts/app-config.yaml" ]; then
            DOCKER_CMD="$DOCKER_CMD -v "$(pwd)"/artifacts/app-config.yaml:/opt/app-root/src/app-config.yaml"
          fi
          if [ -f "./artifacts/app-config.test.yaml" ]; then
            DOCKER_CMD="$DOCKER_CMD -v "$(pwd)"/artifacts/app-config.test.yaml:/opt/app-root/src/app-config.test.yaml"
          fi
          DOCKER_CMD="$DOCKER_CMD -v "$(pwd)"/artifacts/dynamic-plugins.test.yaml:/opt/app-root/src/dynamic-plugins.yaml"
          
          # Add Docker config and environment variables
          echo "Using docker auth file: $HOME/.docker/config.json"
          DOCKER_CMD="$DOCKER_CMD -v $HOME/.docker/config.json:/root/.docker/config.json:ro"
          DOCKER_CMD="$DOCKER_CMD -e REGISTRY_AUTH_FILE=/root/.docker/config.json"
          
          # Derive image tag from target branch
          TARGET_BRANCH="${{ inputs.target-branch }}"
          if [[ "$TARGET_BRANCH" =~ ^release-([0-9]+\.[0-9]+)$ ]]; then
            IMAGE_TAG="next-${BASH_REMATCH[1]}"
          else
            IMAGE_TAG="next"
          fi
          echo "Using RHDH image tag: $IMAGE_TAG (target branch: $TARGET_BRANCH)"
          
          # Add image and command
          DOCKER_CMD="$DOCKER_CMD --entrypoint /bin/bash quay.io/rhdh-community/rhdh:${IMAGE_TAG} -c '"
          DOCKER_CMD="$DOCKER_CMD set -ex; "
          DOCKER_CMD="$DOCKER_CMD PLUGINS_ROOT=/opt/app-root/src/dynamic-plugins-root; "
          DOCKER_CMD="$DOCKER_CMD GENERATED_CONFIG=\$PLUGINS_ROOT/app-config.dynamic-plugins.yaml; "
          DOCKER_CMD="$DOCKER_CMD INSTALL_SCRIPT=/opt/app-root/src/install-dynamic-plugins.sh; "
          DOCKER_CMD="$DOCKER_CMD mkdir -p \$PLUGINS_ROOT; "
          DOCKER_CMD="$DOCKER_CMD \$INSTALL_SCRIPT \$PLUGINS_ROOT; "
          DOCKER_CMD="$DOCKER_CMD exec node packages/backend"
          
          # Add config files to command (optional)
          [ -f "./artifacts/app-config.yaml" ] && DOCKER_CMD="$DOCKER_CMD --config /opt/app-root/src/app-config.yaml"
          [ -f "./artifacts/app-config.test.yaml" ] && DOCKER_CMD="$DOCKER_CMD --config /opt/app-root/src/app-config.test.yaml"
          DOCKER_CMD="$DOCKER_CMD --config /opt/app-root/src/dynamic-plugins.yaml"
          DOCKER_CMD="$DOCKER_CMD --config \$GENERATED_CONFIG'"
          
          echo "Running: $DOCKER_CMD"
          eval "$DOCKER_CMD"

      - name: Wait for RHDH to be ready
        run: |
          set -e
          for i in $(seq 1 10); do
            if curl -fsS http://localhost:7007/health >/dev/null; then
              echo "RHDH is ready"; sleep 10; exit 0; fi
            echo "Waiting for RHDH... (Attempt ${i}/10)"
            # Check if container is still running
            if ! docker ps | grep -q rhdh; then
              echo "Container stopped unexpectedly."
              exit 1
            fi
            sleep 10
          done
          echo "RHDH did not become ready in time."
          exit 1

      - name: Print container debug info
        run: |
          echo "===== Installed plugins"
          docker exec rhdh ls -l /opt/app-root/src/dynamic-plugins-root
          echo "===== Generated dynamic plugins config"
          docker exec rhdh cat /opt/app-root/src/dynamic-plugins-root/app-config.dynamic-plugins.yaml

      - name: Verify plugin loading
        id: collect-results
        run: |
          set -e
          PLUGINS=$(grep -Eo '!([^[:space:]]+)' ./artifacts/dynamic-plugins.test.yaml | sed -e 's/^!//' -e 's/"$//' | sort -u)
          if [ -z "$PLUGINS" ]; then
            echo "No plugins found in dynamic-plugins.test.yaml"
            echo "success=false" >> "$GITHUB_OUTPUT"
            echo "failed-plugins<<EOF" >> "$GITHUB_OUTPUT"
            echo "(no-plugins)" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          LOGS=$(docker logs rhdh 2>&1 || true)
          failures=()

          # Verify backstage startup
          if ! echo "$LOGS" | grep -qiE "backstage info.*listening on"; then
            echo "ERROR: Backstage startup message not found in logs"
            failures+=("(backstage-not-started)")
          fi

          # Verify each plugin loaded
          for plugin in $PLUGINS; do
            if echo "$LOGS" | grep -qiE "loaded dynamic .* plugin .*${plugin}(-dynamic)?'"; then
              echo "  OK: $plugin"
            else
              echo "Plugin NOT loaded: $plugin"
              failures+=("$plugin")
            fi
          done

          # Check for plugin loading errors
          if echo "$LOGS" | grep -qE "(InstallException|Error while adding OCI plugin|Failed to load dynamic plugin|dynamic plugin.*error)"; then
            failures+=("(log-errors)")
          fi

          # Check for plugin initialization errors
          while IFS= read -r line; do
            plugin_name=$(echo "$line" | sed "s/.*Plugin '\([^']*\)'.*/\1/")
            echo "  INIT ERROR: $plugin_name"
            failures+=("$plugin_name (init-error)")
          done < <(echo "$LOGS" | grep -oE "Unhandled rejection Plugin '[^']+' startup failed" || true)

          # Write outputs and exit
          if [ ${#failures[@]} -eq 0 ]; then
            echo "success=true" >> "$GITHUB_OUTPUT"
            echo "failed-plugins<<EOF" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "success=false" >> "$GITHUB_OUTPUT"
            echo "failed-plugins<<EOF" >> "$GITHUB_OUTPUT"
            printf "%s\n" "${failures[@]}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            printf "\nThese plugins failed to load to RHDH:\n"
            printf "%s\n" "${failures[@]}"
            exit 1
          fi

      - name: Capture error logs
        if: always()
        id: capture-errors
        continue-on-error: true
        run: |
          if ! docker ps -a | grep -q rhdh; then
            echo "error-logs<<EOF" >> "$GITHUB_OUTPUT"
            echo "'rhdh' container was not available. Check earlier steps for startup errors." >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          LOGS=$(docker logs rhdh 2>&1 || echo "Failed to retrieve logs")
          ERROR_LINES=$(echo "$LOGS" | grep -E "(backstage (error|warn)|InstallException|Unhandled rejection|Failed to load dynamic plugin|Error while adding OCI plugin)" || true)
          echo "error-logs<<EOF" >> "$GITHUB_OUTPUT"
          if [ -n "$ERROR_LINES" ]; then
            echo "$ERROR_LINES" >> "$GITHUB_OUTPUT"
          else
            echo "No error patterns found in container logs. Check full workflow logs for details." >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Print container logs
        if: always()
        run: docker logs rhdh 2>&1 || true

      - name: Cleanup
        if: always()
        run: docker rm -f rhdh || true
