name: Parse the Test Config modify with Published OCI References and export as artifact

on:
  workflow_call:
    inputs:
      overlay-branch:
        required: true
        type: string
      overlay-repo:
        required: true
        type: string
      workspace-path:
        required: true
        type: string
      published-exports:
        required: false
        type: string
    outputs:
      plugins_metadata_complete:
        description: "True if metadata exists for all referenced plugins"
        value: ${{ jobs.prepareTestConfig.outputs.plugins_metadata_complete }}

jobs:
  prepareTestConfig:
    runs-on: ubuntu-latest
    outputs:
      plugins_metadata_complete: ${{ steps.build-dynamic-plugins.outputs.plugins_metadata_complete }}
    steps:

      - name: Checkout
        uses: actions/checkout@v4.3.0
        with:
          ref: ${{ inputs.overlay-branch }}
          repository: ${{ inputs.overlay-repo }}

      - name: Setup yq
        uses: mikefarah/yq@v4.44.2

      - name: Build dynamic-plugins.test.yaml
        id: build-dynamic-plugins
        run: |
          WORKSPACE_PATH="${{ inputs.workspace-path }}"
          PUBLISHED_EXPORTS="${{ inputs.published-exports }}"
          PLUGINS_FOUND=0
          TOTAL_PLUGINS=0
          PLUGINS_METADATA_COMPLETE="false"

          if [ -z "$PUBLISHED_EXPORTS" ]; then
            echo "No published exports provided. Nothing to do."
            echo "plugins_metadata_complete=$PLUGINS_METADATA_COMPLETE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Count total plugins from exports
          for export in $PUBLISHED_EXPORTS; do
            TOTAL_PLUGINS=$((TOTAL_PLUGINS + 1))
          done

          OUT_DIR="$WORKSPACE_PATH/tests"
          OUT_FILE="$OUT_DIR/dynamic-plugins.test.yaml"
          mkdir -p "$OUT_DIR"

          # Build map of <stripped packageName> -> metadata file path
          declare -A META_MAP
          for file in "$WORKSPACE_PATH"/metadata/*.yaml; do
            [ -e "$file" ] || continue
            pkg=$(yq -r '.packageName // ""' "$file")
            if [ -n "$pkg" ]; then
              stripped=$(echo "$pkg" | sed 's|^@||; s|/|-|')
              META_MAP["$stripped"]="$file"
            fi
          done

          # Always include the root-level default config
          ROOT_CONFIG="$GITHUB_WORKSPACE/tests/app-config.yaml"
          [ -f "$ROOT_CONFIG" ] && cp "$ROOT_CONFIG" "$OUT_DIR/app-config.yaml"

          # Start the resulting YAML file
          echo "plugins:" > "$OUT_FILE"

          # For each published export, extract plugin name and read its metadata
          # Expected export format: ghcr.io/<repo_path>/<plugin_name>:<tag>
          for export in $PUBLISHED_EXPORTS; do
            if [[ "$export" =~ ^ghcr\.io/(.+):([^[:space:]]+)$ ]]; then
              IMAGE_PATH_AND_PLUGIN="${BASH_REMATCH[1]}"   # <repo_path>/<plugin_name>
              NEW_TAG="${BASH_REMATCH[2]}"                 # <tag>
              PLUGIN_NAME="${IMAGE_PATH_AND_PLUGIN##*/}"
              METADATA_FILE="${META_MAP[$PLUGIN_NAME]}"
              if [ -z "$METADATA_FILE" ]; then
                echo "Metadata mapping not found for $PLUGIN_NAME, skipping"
                continue
              fi

              PACKAGE_NAME=$(yq -r '.packageName' "$METADATA_FILE")
              if [ -z "$PACKAGE_NAME" ] || [ "$PACKAGE_NAME" = "null" ]; then
                echo "packageName not found in $METADATA_FILE, skipping"
                continue
              fi

              # Extract plugin config block under configs.default
              if ! yq -e '.configs.default' "$METADATA_FILE" >/dev/null 2>&1; then
                echo "configs.default not found in $METADATA_FILE, skipping"
                continue
              fi

              STRIPPED=$(echo "$PACKAGE_NAME" | sed 's|^@||; s|/|-|')
              echo "- package: \"oci://ghcr.io/${IMAGE_PATH_AND_PLUGIN}:${NEW_TAG}!${STRIPPED}\"" >> "$OUT_FILE"
              echo "  disabled: false" >> "$OUT_FILE"
              echo "  pluginConfig:" >> "$OUT_FILE"
              # Append the configs.default block indented by 4 spaces under pluginConfig
              yq -o=yaml '.configs.default' "$METADATA_FILE" | sed 's/^/    /' >> "$OUT_FILE"
              PLUGINS_FOUND=$((PLUGINS_FOUND + 1))
            else
              echo "Export did not match expected format, skipping: $export"
            fi
          done

          if [ "$PLUGINS_FOUND" -eq 0 ]; then
            echo "[]" >> "$OUT_FILE"
          fi

          if [ "$PLUGINS_FOUND" -eq "$TOTAL_PLUGINS" ] && [ "$TOTAL_PLUGINS" -gt 0 ]; then
            PLUGINS_METADATA_COMPLETE="true"
          fi

          echo "plugins_metadata_complete=$PLUGINS_METADATA_COMPLETE" >> "$GITHUB_OUTPUT"

      - name: Upload integration-test artefact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: integration-test-artifacts
          path: ${{ format('{0}/tests', inputs.workspace-path) }}
          if-no-files-found: error
